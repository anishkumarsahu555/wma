{% extends 'wmaApp/baseIndex.html' %}
{% load static %}
{% block title %}
<title>Manage Payments</title>
{% endblock %}
{% block css %}
{% endblock %}
{% block body %}

<style>

    #UserTable_length {
        left: 20px;
        position: absolute;
    }

    #UserTable_filter {
        width: 50%;
        float: right;
    }

    .dt-buttons {
        position: absolute;
        left: 130px;
    }
    .dt-length{
        position: absolute;
    }

    input[type=search] {
        width: 100px !important;
    }
</style>

<div class="ui right aligned basic  grid">
    <div class="sixteen wide column">
        <div class="ui  pointing secondary menu">
            <div style="cursor: pointer;" class="item active" data-tab="user"
            >Payment List
            </div>
            <div style=" position: absolute;right: 1.5rem;top: 18px;">
                <button class="ui green mini plus button right" onclick="showUserModal()">
                    <i class="plus square outline icon"></i>
                    Add Payment
                </button>
            </div>
        </div>
        <div class="ui tab " data-tab="user">
            <div class="row" style="padding-left: 5px; padding-right: 5px">
                <div class="ui  form">
                    <form class="ui tiny form" style="text-align:left">
                        <div class=" fields">
                            <div class="four wide field" style="width: 30%">
                                <label>Start Date</label>
                                <div class="ui calendar" id="rangestart">
                                    <div class="ui input left icon">

                                        <input class="" type="text" placeholder="Start Date"
                                               style="width:100%;"
                                               id="startDateF" onchange="ChangeDate()">
                                    </div>
                                </div>
                            </div>
                            <div class="three wide field" style="width: 30%">
                                <label>End Date</label>
                                <div class="ui calendar" id="rangeend">
                                    <div class="ui input left icon">

                                        <input class="" type="text" placeholder="End Date"
                                               style="width:100%;"
                                               id="endDateF">
                                    </div>
                                </div>
                            </div>
                            <div class="three wide  field" style="width: 40%">
                                <label>Staff</label>
                                <select class="ui fluid search dropdown" id="staffID" onchange="ChangeDate()">
                                    <option value="All">All</option>
                                    {% for staff in staffs %}
                                    <option value="{{ staff.id }}">{{ staff.name|capfirst }}
                                    </option>
                                    {% endfor %}


                                </select>
                            </div>
                            <div class="seven wide field">
                                <label>Action</label>
                                <button class="ui tiny active button" type="button"
                                        onclick="filterDetails()">
                                    <i class="funnel dollar icon"></i>
                                    Search
                                </button>
                                <!--                                    <a id="reportUrl"-->
                                <!--                                       href=""-->
                                <!--                                       style="float: right;"-->
                                <!--                                       class="teal tiny ui button">Download Report-->
                                <!--                                    </a>-->
                            </div>
                        </div>
                    </form>
                </div>
                <div class="wide">
                    <table class="ui blue unstackable tiny sortable celled very nowrap very compact table" id="UserTable"
                           style="margin-top: 5px;width: 100%">
                        <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Amount(â‚¹)</th>
                            <th>IsApproved</th>
                            <th>ApprovedBy</th>
                            <th>PaymentDate</th>
                            <th>AddedBy</th>
                            <th>Remark</th>
                            <th>Added On</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>

                <div class="ui modal" id="myModalUser">
                    <i class="close icon"></i>
                    <div class="header">
                        Add Payment Record
                    </div>
                    <div class="content">
                        <form class="ui tiny form" id="addForm">{% csrf_token %}
                            <div class="one required fields">
                                <div class="sixteen wide field">
                                    <label>Customer</label>
                                    <select class="ui clearable search dropdown" id="customer">
                                        <option value="">Search By Customer Name</option>
                                    </select>
                                </div>
                            </div>
                            <div class="one required fields">

                                <div class="sixteen wide field">
                                    <label>Amount</label>
                                    <input type="number" name="amount" placeholder="Amount" id="amount">
                                </div>

                            </div>
                            <div class="one fields">
                                <div class="sixteen wide field">
                                    <label>Any Remark</label>
                                    <textarea name="remark" id="remark" placeholder="remark" rows="2"></textarea>
                                </div>
                            </div>

                        </form>
                        <div class="actions" style="padding-top: 20px; padding-bottom: 20px ;float: right">
                            <div class="ui cancel button">Cancel</div>
                            <button class="ui right labeled icon button green saveBtn" onclick="addDetail()">
                                Submit
                                <i class="checkmark icon"></i>
                            </button>
                            <button style="display: none" class="ui right labeled icon button green saveBtnLoad" >
                                Saving ...
                                <i class="checkmark icon"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="ui basic modal custom" id="deleteUser">
                <div class="ui icon header">
                    <i class="archive icon"></i>
                    Details will be Deleted
                </div>
                <div class="content">
                    <p style="text-align: center">The detail will be deleted, are you sure to delete this Detail?</p>
                </div>
                <div class="actions">
                    <div class="ui red basic cancel inverted button">
                        <i class="remove icon"></i>
                        No
                    </div>
                    <input type="hidden" id="UserID">
                    <div class="ui green ok inverted button" onclick="deleteDetail()">
                        <i class="checkmark icon"></i>
                        Yes
                    </div>
                </div>
            </div>

            <div class="ui modal" id="userModal">
                <i class="close icon"></i>
                <div class="header">
                    Edit Details
                </div>
                <div class="content">

                    <form class="ui tiny form" id="EditForm">{% csrf_token %}

                        <div class="one required fields">
                            <div class="sixteen wide field">
                                <label>Customer</label>
                                <select class="ui clearable search dropdown" id="customerEdit">
                                    <option value="">Search By Customer Name</option>
                                </select>
                            </div>
                        </div>
                        <div class="one required fields">

                            <div class="sixteen wide field">
                                <label>Amount</label>
                                <input type="number" name="amount" placeholder="Amount" id="amountEdit">
                            </div>

                        </div>
                        <div class="one fields">
                            <div class="sixteen wide field">
                                <label>Any Remark</label>
                                <textarea name="remark" id="remarkEdit" placeholder="remark" rows="2"></textarea>
                            </div>
                        </div>

                        <input type="hidden" id="EditUserId">
                    </form>

                    <div class="actions" style="padding-top: 20px; padding-bottom: 20px ;float: right">
                        <div class="ui cancel button">Cancel</div>
                        <button class="ui right labeled icon button green saveBtn" onclick="editDetail()">
                            Update
                            <i class="checkmark icon"></i>
                        </button>
                        <button style="display: none" class="ui right labeled icon button green saveBtnLoad" >
                            Saving ...
                            <i class="checkmark icon"></i>
                        </button>
                    </div>
                </div>
            </div>


        </div>
    </div>
</div>
{% endblock %}

{% block js %}
<script>
    var today = new Date();
    $('#rangestart').calendar({
        initialDate: today.getDate() + '/' + (today.getMonth() + 1) + '/' + today.getFullYear(),
        monthFirst: false,
        type: 'date',
        endCalendar: $('#rangeend'),
        formatter: {
            date: function (date, settings) {
                if (!date) return '';
                var day = date.getDate();
                var month = date.getMonth() + 1;
                var year = date.getFullYear();
                return day + '/' + month + '/' + year;
            }
        }
    });
    $('#rangeend').calendar({
        initialDate: today.getDate() + '/' + (today.getMonth() + 1) + '/' + today.getFullYear(),
        monthFirst: false,
        type: 'date',
        startCalendar: $('#rangestart'),
        formatter: {
            date: function (date, settings) {
                if (!date) return '';
                var day = date.getDate();
                var month = date.getMonth() + 1;
                var year = date.getFullYear();
                return day + '/' + month + '/' + year;
            }
        }
    });

    var userTab;


    function showUserModal() {
        $('#myModalUser').modal('show');
        myOwnReset();
    }


    function addDetail() {
        showLoading();
        var customer = $('#customer').val();
        var amount = $('#amount').val();
        var remark = $('#remark').val();
        if (customer === ''|| amount === '' ) {
            $('body')
                .toast({
                    class: 'orange',
                    message: '* fields are required'
                })
            ;
            hideLoading();
            return false;
        }
        var csrfmiddlewaretoken = $("input[name='csrfmiddlewaretoken']").val();

        data = new FormData();
        data.append('customer', customer);
        data.append('amount', amount);
        data.append('remark', remark);
        data.append('csrfmiddlewaretoken', csrfmiddlewaretoken);
        $.ajax({
            type: 'post',
            url: "{% url 'wma_api:add_payment_api' %}",
            data: data,
            contentType: false,
            cache: false,
            processData: false,
            success: function (response) {
                if (response.success) {
                    $('body')
                        .toast({
                            class: 'success',
                            message:response.message
                        })
                    ;


                    userTab.ajax.reload(null, false);
                    $('#addForm').trigger('reset');
                    $('#myModalUser').modal('toggle');
                    hideLoading();
                } else {
                    $('body')
                        .toast({
                            class: 'error',
                            message: response.message
                        })
                    ;
                    hideLoading();

                }

                return response;
            },
            error: function (xhr, status, error) {
                response = JSON.parse(xhr.responseText);

                if(!response.success){
                    $('body')
                        .toast({
                            class: 'error',
                            message: response.message
                        })
                    ;
                    hideLoading();
                }
                else{
                    $('body')
                        .toast({
                            class: 'error',
                            message: 'An error occurred !'
                        })
                    ;
                    hideLoading();
                }


            }
        });


    }


    // user Details

    userTab = $('#UserTable').DataTable({
        dom: 'Blfrtip',
        "scrollY": "350px",
        "scrollX": true,
        fixedColumns: {
            left: 1,
            right: 1
        },
        buttons: [{
            extend: 'excel',
            exportOptions: {
                columns: [0,1, 2, 3,4,5,6,7]
            }
        }

        ],
        language: {
            lengthMenu: "_MENU_ entries"
        },
        "columnDefs": [
            {"name": "customerID", "targets": 0, "orderable": true},
            {"name": "paymentAmount", "targets": 1, "orderable": true},
            {"name": "isApprove", "targets": 2, "orderable": true},
            {"name": "approvedBy", "targets": 3, "orderable": true},
            {"name": "paymentDate", "targets": 4, "orderable": true},
            {"name": "addedByID", "targets": 5, "orderable": true},
            {"name": "remark", "targets": 6, "orderable": true},
            {"name": "datetime", "targets": 7, "orderable": true},
            {"name": "action", "targets": 8, "orderable": false}
        ],
        aaSorting: [[7, 'desc']],
        "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
        "pageLength": 10,
        "processing": true,
        "serverSide": true,
        "ajax": "{% url 'wma_api:PaymentListJson' %}"
    });


    function delUser(id) {
        $('#deleteUser')
            .modal('show')
        ;
        $('#UserID').val(id)
    }

    function deleteDetail() {
        var id = $('#UserID').val();
        var formdata = new FormData();
        formdata.append('id', id);

        $.ajax({
            url: "{% url 'wma_api:delete_payment_api' %}",
            type: "post",
            data: formdata,
            contentType: false,
            cache: false,
            processData: false,

            success: function (response) {
                if (response.success) {
                    $('body')
                        .toast({
                            class: 'success',
                            message: response.message
                        })
                    ;


                    userTab.ajax.reload(null, false);
                } else {
                    $('body')
                        .toast({
                            class: 'error',
                            message: response.message
                        })
                    ;

                }

                return response;
            },
            error: function () {
                $('body')
                    .toast({
                        class: 'error',
                        message: 'An error occurred !'
                    })
                ;
            }
        });

    }

    function GetUserDetails(id) {
        myOwnReset();
        $('#userModal').modal('show');
        // var formdata = new FormData();
        // formdata.append('id', id);
        debugger;
        $.ajax({
            type: 'get',
            url: "{% url 'wma_api:get_payment_detail' %}",
            data: { id: id },
            success: function (response) {
                $('#EditUserId').val(response.data['id']);
                $('#customerEdit').val(response.data['customerID']).change();
                $('#amountEdit').val(response.data['amount']);
                $('#remarkEdit').val(response.data['remark']);

            },
            error: function () {
                $('body')
                    .toast({
                        class: 'error',
                        message: 'An error occurred !'
                    })
                ;
            }
        });
    }

    function editDetail() {
        showLoading();
        var id = $('#EditUserId').val();
        var customer = $('#customerEdit').val();
        var amount = $('#amountEdit').val();
        var remark = $('#remarkEdit').val();

        if (customer === ''|| amount === '') {
            $('body')
                .toast({
                    class: 'orange',
                    message: '* fields are required'
                })
            ;
            hideLoading();
            return false;
        }
        var csrfmiddlewaretoken = $("input[name='csrfmiddlewaretoken']").val();

        data = new FormData();
        data.append('id', id);
        data.append('customer', customer);
        data.append('amount', amount);
        data.append('remark', remark);
        data.append('csrfmiddlewaretoken', csrfmiddlewaretoken);

        $.ajax({
            type: 'post',
            url: "{% url 'wma_api:update_payment_api' %}",
            data: data,
            contentType: false,
            cache: false,
            processData: false,
            success: function (response) {
                console.log(response);
                if (response.success) {
                    $('body')
                        .toast({
                            class: 'success',
                            message:response.message
                        })
                    ;


                    userTab.ajax.reload(null, false);
                    $('#EditForm').trigger('reset');
                    $('#userModal').modal('toggle');
                    hideLoading();
                } else {
                    $('body')
                        .toast({
                            class: 'error',
                            message: response.message
                        })
                    ;
                    hideLoading();

                }

                return response;
            },
            error: function (xhr, status, error) {
                response = JSON.parse(xhr.responseText);

                if(!response.success){
                    $('body')
                        .toast({
                            class: 'error',
                            message: response.message
                        })
                    ;
                    hideLoading();
                }
                else{
                    $('body')
                        .toast({
                            class: 'error',
                            message: 'An error occurred !'
                        })
                    ;
                    hideLoading();
                }


            }
        });


    }

    $(document).ready(function(){
        $('.ui.form')
            .form({
                fields: {
                    fileInput:{
                        identifier: 'name',
                        rules: [
                            {
                                type : 'empty'
                            }
                        ]
                    }
                }
            });
    });

    function myOwnReset(){
        $('.ui.form').form('reset');
    }

    $(getCustomerList());


    function getCustomerList() {
        $.ajax({
            type: 'get',
            url: "{% url 'wma_api_cached:customer_list_api_cached' %}",

            success: function (response) {
                console.log(response);

                $('#customer').html('');
                $('#customerEdit').html('');
                $('#customer').append(' <option value="">Search By Customer Name</option>');
                $('#customerEdit').append(' <option value="">Search By Customer Name</option>');
                var j;
                for (j = 0; j < response.data.length; j++) {

                    $('#customer').append('<option value="' + response.data[j]['ID'] + '" >' + response.data[j]['DisplayDetail'] + '</option>');
                    $('#customerEdit').append('<option value="' + response.data[j]['ID'] + '" >' + response.data[j]['DisplayDetail'] + '</option>');

                }

            },

            error: function () {
                $('body')
                    .toast({
                        class: 'error',
                        message: 'An error occurred !'
                    })
                ;
            }
        });


    }

    function filterDetails() {
        var startDate = $('#startDateF').val();
        var endDate = $('#endDateF').val();
        var staffID = $('#staffID').val();
        userTab.ajax.url('{% url 'wma_api:PaymentListJson' %}?startDate=' + startDate + '&endDate=' + endDate + '&staffID=' + staffID).load();

    }

</script>

{% endblock %}