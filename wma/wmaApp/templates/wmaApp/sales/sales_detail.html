{% extends 'wmaApp/baseIndex.html' %}
{% load static %}
{% block title %}
<title>Sales Detail</title>
{% endblock %}
{% block css %}
<style>
    .gradient-header {
        background: linear-gradient(135deg, #193038, #4a90e2);
        color: white !important;
        padding: 1.2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
    }
    .gradient-header .sub.header {
        color: #dcdcdc !important;
    }
    .ui.card {
        border-radius: 15px !important;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08) !important;
    }
    .customer-card .content, .sale-card .content {
        color: white !important;
    }

</style>
{% endblock %}
{% block body %}


<div class="ui aligned  basic  grid">
    <div class="sixteen wide column">
        <div class="ui  pointing secondary menu">
            <div style="cursor: pointer;" class="item active" data-tab="user"
            >Sales Detail
            </div>
            <div style=" position: absolute;right: 1.5rem;top: 18px;">
                <a href="{% url 'wmaApp:add_sale' %}" class="ui green mini plus button right">
                    <i class="plus square outline icon"></i>
                    Add Sales
                </a>
            </div>
        </div>

        <div class="ui tab " data-tab="user">

            <div class="row" style="padding-left: 5px; padding-right: 5px">
                <div class="ui container" style="margin-top:2rem;">

                    <!-- Page Header -->
                    <div class="gradient-header">
                        <h2 class="ui header" style="color:white;">
                            <i class="file alternate outline icon"></i>
                            <div class="content">
                                Sales Detail
                                <div class="sub header">Invoice #{{ object.invoiceNumber }}</div>
                            </div>
                        </h2>
                    </div>

                    <!-- Customer & Sale Info -->
                    <div class="ui stackable two column grid">
                        <!-- Customer Info -->
                        <div class="column">
                            <div class="ui fluid card" style="border-top: 4px solid #f7971e;">
                                <div class="content">
                                    <h4 class="ui header">
                                        <i class="user circle orange icon"></i>
                                        <div class="content">Customer Info</div>
                                    </h4>
                                    <div class="ui relaxed divided list">
                                        <div class="item">
                                            <strong>Name:</strong> {{ object.customerID.name }}
                                        </div>
                                        <div class="item">
                                            <strong>Phone:</strong> {{ object.customerID.phone }}
                                        </div>
                                        <div class="item">
                                            <strong>Email:</strong> {{ object.customerID.email }}
                                        </div>
                                        <div class="item">
                                            <strong>Address:</strong> {{ object.customerID.address }}
                                        </div>
                                        <div class="item">
                                            <strong>Location:</strong> {{ object.customerID.locationID.name }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sale Info -->
                        <div class="column">
                            <div class="ui fluid card " style="border-top: 4px solid #21ba45;">
                                <div class="content">
                                    <h4 class="ui header">
                                        <i class="shopping cart green icon"></i>
                                        <div class="content">Sale Info</div>
                                    </h4>
                                    <div class="ui relaxed divided list">
                                        <div class="item">
                                            <strong>Date:</strong> {{ object.saleDate|date:"d-m-Y" }}
                                        </div>
                                        <div class="item">
                                            <strong>Total:</strong> ₹ {{ object.totalAmount }}
                                        </div>
                                        <div class="item">
                                            <strong>Additional Charges:</strong> ₹ {{ object.additionalCharge }}
                                        </div>
                                        <div class="item">
                                            <strong>Tax:</strong> ₹ {{ object.totalTax }}
                                        </div>
                                        <div class="item">
                                            <strong>Final Amount:</strong> <span style="color:#21ba45; font-weight:bold;">₹ {{ object.totalAmountAfterTax }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Products Table -->
                    <div class="ui fluid card" style="margin-top:2rem;">
                        <div class="content">
                            <div class="header">Products</div>
                        </div>
                        <div class="content">
                            <table class="ui teal celled unstackable table">
                                <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Unit</th>
                                    <th>Qty</th>
                                    <th>Unit Price</th>
                                    <th>Remark</th>
                                    <th>Total</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for p in products %}
                                <tr>
                                    <td>{{ p.productName }}</td>
                                    <td>{{ p.unit }}</td>
                                    <td>{{ p.quantity }}</td>
                                    <td>₹{{ p.unitPrice }}</td>
                                    <td>{{ p.remark }}</td>
                                    <td>₹{{ p.totalAmountAfterTax }}</td>
                                </tr>
                                {% endfor %}

                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Remarks -->
                    <div class="ui segment">
                        <h4 class="ui dividing header">Remark</h4>
                        <p>{{ object.remark }}</p>
                    </div>

                    <!-- Action Buttons -->
                    <div class="ui stackable grid">
                        <div class="sixteen wide column" style="text-align:right; margin-top:1rem;">
                            <a class="ui grey button" href="{% url 'wmaApp:manage_sale' %}"
                     >
                                <i class="arrow left icon"></i> Back
                            </a>
                            <a class="ui blue button" href="{% url 'wmaApp:edit_sale' object.id %}">
                                <i class="edit icon"></i> Edit
                            </a>
<!--                            <button class="ui green button">-->
<!--                                <i class="print icon"></i> Print Invoice-->
<!--                            </button>-->
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

{% endblock %}

{% block js %}
<script>

    var today = new Date();
    $('#rangestart').calendar({
        initialDate: today.getDate() + '/' + (today.getMonth() + 1) + '/' + today.getFullYear(),
        monthFirst: false,
        type: 'date',
        endCalendar: $('#rangeend'),
        formatter: {
            date: function (date, settings) {
                if (!date) return '';
                var day = date.getDate();
                var month = date.getMonth() + 1;
                var year = date.getFullYear();
                return day + '/' + month + '/' + year;
            }
        }
    });
    $('#rangeend').calendar({
        initialDate: today.getDate() + '/' + (today.getMonth() + 1) + '/' + today.getFullYear(),
        monthFirst: false,
        type: 'date',
        startCalendar: $('#rangestart'),
        formatter: {
            date: function (date, settings) {
                if (!date) return '';
                var day = date.getDate();
                var month = date.getMonth() + 1;
                var year = date.getFullYear();
                return day + '/' + month + '/' + year;
            }
        }
    });


    var userTab;


    // user Details

    userTab = $('#UserTable').DataTable({
        dom: 'Blfrtip',
        "scrollY": "350px",
        "scrollX": true,
        fixedColumns: {
            left: 1,

        },
        buttons: [{
            extend: 'excel',
            exportOptions: {
                columns: [0, 1, 2, 3, 4, 5, 6, 7, 8]
            }
        }

        ],
        language: {
            lengthMenu: "_MENU_ entries"
        },
        "columnDefs": [
            {"name": "invoiceNumber", "targets": 0, "orderable": true},
            {"name": "saleDate", "targets": 1, "orderable": true},
            {"name": "customerID", "targets": 2, "orderable": true},
            {"name": "totalAmount", "targets": 3, "orderable": true,"className": "dt-body-right"},
            {"name": "totalTax", "targets": 4, "orderable": false},
            {"name": "additionalCharge", "targets": 5, "orderable": true},
            {"name": "totalAmountAfterTax", "targets": 6, "orderable": true},
            {"name": "addedByID", "targets": 7, "orderable": true},
            {"name": "dateCreated", "targets": 8, "orderable": true},
            {"name": "action", "targets": 9, "orderable": false},


        ],
        aaSorting: [[8, 'desc']],
        "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
        "pageLength": 10,
        "processing": true,
        "serverSide": true,
        "ajax": "{% url 'wma_api:SalesListJson' %}",
    });


    function delUser(id) {
        $('#deleteUser')
            .modal('show')
        ;
        $('#UserID').val(id)
    }

    function deleteUser() {
        showLoading();
        var id = $('#UserID').val();
        var formdata = new FormData();
        formdata.append('id', id);

        $.ajax({
            url: "{% url 'wma_api:delete_sales_api' %}",
            type: "post",
            data: formdata,
            contentType: false,
            cache: false,
            processData: false,

            success: function (response) {
                if (response.success) {
                    $('body')
                        .toast({
                            class: 'success',
                            message: response.message
                        })
                    ;


                    userTab.ajax.reload(null, false);
                    hideLoading();
                } else {
                    $('body')
                        .toast({
                            class: 'error',
                            message: response.message
                        })
                    ;
                    hideLoading();
                }

                return response;
            },
            error: function () {
                $('body')
                    .toast({
                        class: 'error',
                        message: 'An error occurred !'
                    })
                ;
                hideLoading()
            }
        });

    }

    function filterDetails() {
        var startDate = $('#startDateF').val();
        var endDate = $('#endDateF').val();
        var staffID = $('#staffID').val();
        userTab.ajax.url('{% url 'wma_api:SalesListJson' %}?startDate=' + startDate + '&endDate=' + endDate + '&staffID=' + staffID).load();

    }

    function showConfirmationModal(id) {
        $('#imgModal').modal('show');
        $('#approveCollectionID').val('' + id);
    }



</script>

{% endblock %}